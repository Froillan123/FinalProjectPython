{% extends 'base.html' %}
{% block content %}
<div class='w3-container w3-blue w3-margin-bottom header'>
    <h3 class="w3-left w3-margin-left w3-margin-top">{{ pagetitle }}</h3>
</div>

<div class="w3-container">
    <!-- Camera feed -->
    <div id="camera-container" class="w3-center">
        <video id="camera" width="400" autoplay></video>
    </div>
    <div class="w3-center w3-margin-top">
        <button id="start-camera" class="w3-button w3-green">Start Camera</button>
        <button id="stop-camera" class="w3-button w3-red">Stop Camera</button>
    </div>

    <!-- Scanning feedback -->
    <div id="result" class="w3-container w3-padding w3-margin-top w3-border w3-round w3-light-gray" style="display: none;">
        <h4>Scanned User Information</h4>
        <p><b>IDNO:</b> <span id="idno"></span></p>
        <p><b>LASTNAME:</b> <span id="lastname"></span></p>
        <p><b>FIRSTNAME:</b> <span id="firstname"></span></p>
        <p><b>COURSE:</b> <span id="course"></span></p>
        <p><b>LEVEL:</b> <span id="level"></span></p>
    </div>
    <div id="error" class="w3-container w3-padding w3-margin-top w3-border w3-round w3-red" style="display: none;">
        <p>Error: Unable to fetch user information.</p>
    </div>
</div>

<script src="webcam.min.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>
<script>
    const camera = document.getElementById("camera");
    const resultDiv = document.getElementById("result");
    const errorDiv = document.getElementById("error");
    const idnoSpan = document.getElementById("idno");
    const lastnameSpan = document.getElementById("lastname");
    const firstnameSpan = document.getElementById("firstname");
    const courseSpan = document.getElementById("course");
    const levelSpan = document.getElementById("level");

    const qrCodeScanner = new Html5Qrcode("camera");

    async function startCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            camera.srcObject = stream;
        } catch (err) {
            alert("Unable to access the camera.");
        }
    }

    function stopCamera() {
        const stream = camera.srcObject;
        if (stream) {
            const tracks = stream.getTracks();
            tracks.forEach((track) => track.stop());
            camera.srcObject = null;
        }
    }

    function startQrScanner() {
        qrCodeScanner.start(
            { facingMode: "environment" },
            { fps: 10, qrbox: 250 },
            async (decodedText) => {
                const idno = decodedText.trim();
                fetch(`/get_user/${idno}`)
                    .then((response) => response.json())
                    .then((data) => {
                        if (data.error) {
                            resultDiv.style.display = "none";
                            errorDiv.style.display = "block";
                        } else {
                            // Populate user details
                            idnoSpan.textContent = data.idno;
                            lastnameSpan.textContent = data.lastname;
                            firstnameSpan.textContent = data.firstname;
                            courseSpan.textContent = data.course;
                            levelSpan.textContent = data.level;

                            errorDiv.style.display = "none";
                            resultDiv.style.display = "block";
                        }
                    })
                    .catch(() => {
                        resultDiv.style.display = "none";
                        errorDiv.style.display = "block";
                    });
            },
            (errorMessage) => {
                console.log(errorMessage);
            }
        );
    }

    // Start camera automatically with QR scanner after 5 seconds
    window.onload = function () {
        setTimeout(() => {
            startCamera();
            startQrScanner();
        }, 5000); // Delay of 5 seconds
    };

    // Manual start/stop buttons
    document.getElementById("start-camera").addEventListener("click", startCamera);
    document.getElementById("stop-camera").addEventListener("click", stopCamera);
</script>

{% endblock %}
