{% extends 'base.html' %}
{% block header %}
    {% include 'header.html' %}
{% endblock %}
{% block content %}


<div class="w3-row-padding" id="main_container" style="height: 100vh;">
    <div class="w3-full" style="padding: 1rem 3%;">
        <!-- Wrapper for horizontal scrolling -->
        <div class="styled-table-wrapper">
            <table class="w3-table-all styled-table" id="table">
                <thead>
                    <tr id="tr1">
                        <th class="w3-center">IDNO</th>
                        <th class="w3-center">LASTNAME</th>
                        <th class="w3-center">FIRSTNAME</th>
                        <th class="w3-center">COURSE</th>
                        <th class="w3-center">LEVEL</th>
                        <th class="w3-center">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr id="tr2">
                        <td class="w3-center" data-cell="IDNO:">
                            <a href="javascript:void(0);" onclick="viewStudent('{{ user['idno'] }}')">{{ user['idno'] }}</a>
                        </td>
                        
                        <td class="w3-center" data-cell="LASTNAME:">{{ user["lastname"] }}</td>
                        <td class="w3-center" data-cell="FIRSTNAME:">{{ user["firstname"] }}</td>
                        <td class="w3-center" data-cell="COURSE:">{{ user["course"] }}</td>
                        <td class="w3-center" data-cell="LEVEL:">{{ user["level"] }}</td>
                        <td class="w3-center" data-cell="ACTION:">
                            <button class="w3-button w3-red delete-btn delete" onclick="openCustomAlert('{{ user['idno'] }}')">
                                <i class="fas fa-times"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div id="viewModal" class="view-modal" style="display: none;">
    <div class="view-modal-content w3-card-4">
        <div class="description" style="display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid black; padding: 10px;">
            <p style="text-align: center; flex-grow: 1; margin: 0; color: #2196F3; font-size: 18px;">Student Description</p>
            <i class="fas fa-times w3-right" onclick="closeViewModal()" style="cursor: pointer; font-size: 25px; margin-top: -0.9rem; color: red;"></i>
        </div>
        <p class="w3-center w3-padding">
            <div class="view-image">
                <img id="image-view" class="image" />
                <img id="qr-view" class="image" />
            </div>
        </p>
        <form method="post" action="/addstudent" enctype="multipart/form-data">
            <input type="hidden" name="flag" id="flag" value="0"> 
            <input type="hidden" id="idno" name="idno">
            <p>
                <label><b>IDNO</b></label>
                <input type="text" id="idno-view" name="idno" class="w3-input" readonly>
            </p>
            <p>
                <label><b>LASTNAME</b></label>
                <input type="text" id="lastname-view" name="lastname" class="w3-input" readonly>
            </p>
            <p>
                <label><b>FIRSTNAME</b></label>
                <input type="text" id="firstname-view" name="firstname" class="w3-input" readonly>
            </p>
            <p>
                <label><b>COURSE</b></label>
                <input type="text" id="course-view" name="course" class="w3-input" readonly>
            </p>
            <p>
                <label><b>LEVEL</b></label>
                <input type="text" id="level-view" name="level" class="w3-input" readonly>
            </p>
        </form>
    </div>
</div>

<div id="customAlert" style="display: none;">
    <div class="alert-content">
        <h3>Are you sure you want to delete this student?</h3>
        <div class="alert-buttons">
            <form method="post" action="/delete_user" id="deleteForm">
                <input type="hidden" id="deleteIdNo" name="idno">
                <button type="submit" class="confirm-btn w3-red w3-button">Confirm</button>
            </form>
            <button class="cancel-btn w3-blue w3-button w3-margin-top w3-margin-bottom" onclick="closeAlert()">Cancel</button>
        </div>
    </div>
</div>

<script>
    function openCustomAlert(idno) {
        document.getElementById('deleteIdNo').value = idno;
        document.getElementById('customAlert').style.display = 'flex'; 
    }

    function closeAlert() {
        document.getElementById('customAlert').style.display = 'none';
    }

    (function () {
        if (window.history && window.history.pushState) {
            window.history.pushState(null, null, window.location.href);
            window.onpopstate = function () {
                window.history.pushState(null, null, window.location.href);
            };
        }
    })();

    function viewStudent(idno) {
    fetch(`/get_student/${idno}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
            } else {
                document.getElementById('idno-view').value = data.idno;
                document.getElementById('lastname-view').value = data.lastname;
                document.getElementById('firstname-view').value = data.firstname;
                document.getElementById('course-view').value = data.course;
                document.getElementById('level-view').value = data.level;

                const imageElement = document.getElementById('image-view');
                if (data.image) {
                    imageElement.src = data.image;
                } else {
                    imageElement.src = '/static/images/default.png';
                }
                const qrElement = document.getElementById('qr-view');
                if (data.qr_code) {
                    qrElement.src = data.qr_code;
                } else {
                    qrElement.src = '/static/images/qrcode/default.png'; 
                }

                document.getElementById('viewModal').style.display = 'flex';
            }
        })
        .catch(error => {
            console.error('Error fetching student data:', error);
            alert('An error occurred while fetching student data.');
        });
}

function closeViewModal() {
    document.getElementById('viewModal').style.display = 'none';
}
</script>

{% endblock %}
